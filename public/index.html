<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Verse Lab</title>
<style>
  :root{
    --ink:#000;--paper:#fff;--panel:rgba(16,17,20,.72);--muted:#b9c1cc;
    --ring:#fff;
  }
  html,body{height:100%;margin:0;background:#000;color:#fff;font:15px/1.45 -apple-system,system-ui,Segoe UI,Roboto,ui-monospace}
  canvas{position:fixed;inset:0;display:block;background:#000}
  .hint{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);color:#a9b1ba;user-select:none;text-align:center;opacity:.8}
  .sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .18s ease;
         background:rgba(12,12,14,.78);backdrop-filter:saturate(1.1) blur(10px);border-top:1px solid rgba(255,255,255,.14);
         padding:12px 12px calc(12px + env(safe-area-inset-bottom,0)); z-index:10}
  .sheet.open{transform:translateY(0)}
  textarea{width:100%;min-height:120px;max-height:42vh;border:1px solid rgba(255,255,255,.16);background:#0a0b0e;color:#fff;
           border-radius:12px;padding:12px 12px 16px;font:16px ui-monospace,monospace;outline:none;resize:none}
  .row{display:flex;gap:10px;margin-top:10px}
  .btn{flex:0 0 auto;border:1px solid rgba(255,255,255,.18);background:#fff;color:#000;border-radius:999px;padding:8px 14px;font-weight:600}
  .btn.ghost{background:transparent;color:#fff}
  /* tiny on-screen error console */
  .err{position:fixed;left:8px;bottom:8px;max-width:80vw;background:rgba(255,40,40,.1);border:1px solid rgba(255,90,90,.35);
       color:#ffd2d2;border-radius:8px;padding:6px 8px;font:12px/1.25 ui-monospace,monospace;white-space:pre-wrap;z-index:20}
</style>
</head>
<body>
<canvas id="stage"></canvas>

<div id="hint" class="hint">tap to paste a seed<br/><span style="opacity:.7">Or add <code>?seed=your+text</code> to the URL.</span></div>

<div class="sheet" id="sheet">
  <textarea id="seedBox" spellcheck="false" placeholder="Paste or type, then Apply…"></textarea>
  <div class="row">
    <button class="btn" id="apply">Apply</button>
    <button class="btn ghost" id="close">Close</button>
  </div>
</div>

<div id="err" class="err" style="display:none"></div>

<script type="module">
/* ======= imports (ensure these paths exist and the modules export what we use) ======= */
import { makeEngine } from './js/engine.js';
import { resolveSeed } from './js/resolver.js';           // your resolver → {params, metaEvents}
import './js/spellbook-resolver.js';                       // if it monkey-patches / registers books

/* ======= canvas bootstrap ======= */
const canvas = document.getElementById('stage');
const ctx = canvas.getContext('2d', { alpha:false });
function fit(){
  const dpr = Math.max(1, Math.min(3, devicePixelRatio||1));
  canvas.width = Math.floor(innerWidth*dpr);
  canvas.height = Math.floor(innerHeight*dpr);
  canvas.style.width = innerWidth+'px';
  canvas.style.height = innerHeight+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener('resize', fit, {passive:true}); fit();

/* ======= UI ======= */
const sheet = document.getElementById('sheet');
const box   = document.getElementById('seedBox');
const hint  = document.getElementById('hint');
const errEl = document.getElementById('err');

function openSheet(){ sheet.classList.add('open'); box.focus(); setTimeout(()=>box.select(),0); }
function closeSheet(){ sheet.classList.remove('open'); }
addEventListener('click', (e)=>{ if(!sheet.contains(e.target)) openSheet(); });
document.getElementById('apply').onclick = ()=> applySeed();
document.getElementById('close').onclick = ()=> closeSheet();

/* ======= engine ======= */
const engine = makeEngine(canvas);

/* quick visible fallback so screen isn’t black */
function showHello(){
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle='#000'; ctx.fillRect(0,0,innerWidth,innerHeight);
  const cx=innerWidth/2, cy=innerHeight/2, R=Math.min(cx,cy)*0.42;
  ctx.globalCompositeOperation='screen';
  ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=1;
  ctx.beginPath();
  for(let a=0;a<Math.PI*2;a+=0.02){
    const r = R + Math.sin(a*14)*2;
    const x = cx + r*Math.cos(a), y = cy + r*Math.sin(a);
    (a===0)?ctx.moveTo(x,y):ctx.lineTo(x,y);
  }
  ctx.stroke();
}

/* on-screen error helper */
function showError(e){
  errEl.style.display='block';
  errEl.textContent = (e?.stack || e?.message || String(e)).slice(0,2000);
  console.error(e);
}

/* apply seed safely */
async function applySeed(){
  try{
    const text = (box.value||'').trim();
    if(!text) return;
    const state = await resolveSeed(text);   // must exist and return {params, metaEvents?}
    if(state?.params) engine.applyParams(state.params);
    if(state?.metaEvents) for(const m of state.metaEvents) engine.applyMeta?.(m);
    engine.kick?.();
    hint.style.display='none';
    closeSheet();
  }catch(e){ showError(e); }
}

/* ======= boot sequence ======= */
async function boot(){
  try{
    showHello();                    // always draw something
    // URL ?seed=
    const q = new URLSearchParams(location.search);
    if(q.has('seed')){
      box.value = q.get('seed');
      await applySeed();
      return;
    }
  }catch(e){ showError(e); }
  // Don’t attempt auto-clipboard on iOS; it will be rejected without a gesture.
}
boot();
<script type="module" src="./js/engine.js"></script>
<script type="module" src="./js/resolver.js"></script>
<script type="module" src="./js/spellbook-resolver.js"></script>
</body>
</html>
