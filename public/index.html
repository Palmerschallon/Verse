<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Verse • Core Demo</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font:16px ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
  canvas{position:fixed;inset:0;display:block;background:#000}
  /* paste overlay */
  .sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);
    background:rgba(12,12,14,.78);backdrop-filter:blur(10px) saturate(1.1);
    border-top:1px solid rgba(255,255,255,.12);padding:14px 14px calc(14px + env(safe-area-inset-bottom,0));
    transition:transform .18s ease;z-index:10}
  .sheet.open{transform:translateY(0)}
  textarea{width:100%;min-height:120px;max-height:38vh;border:1px solid rgba(255,255,255,.18);background:#0b0c0f;color:#fff;
    border-radius:12px;padding:12px 12px 16px;font:16px ui-monospace,Menlo,Consolas,monospace;outline:none;resize:none}
  .row{display:flex;gap:10px;margin-top:10px}
  .btn{flex:0 0 auto;border:1px solid rgba(255,255,255,.2);background:#fff;color:#000;border-radius:999px;padding:8px 14px;font-weight:600}
  .btn.ghost{background:transparent;color:#fff}
  .hint{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);color:#9aa3ad;font:14px/1.4 ui-sans-serif;letter-spacing:.2px;opacity:.8;text-align:center;user-select:none}
</style>
</head>
<body>
<canvas id="stage"></canvas>

<div id="hint" class="hint">
  tap to paste a seed<br/>
  <span style="opacity:.7">Words map via spellbooks. Ring, spiral, lattice; calm, tide, trails; catastrophes if invoked.</span>
</div>

<!-- Paste-only overlay -->
<div class="sheet" id="sheet">
  <textarea id="seedBox" maxlength="4000" spellcheck="false" placeholder="Paste any text (poem, paragraph, file snippet)…"></textarea>
  <div class="row">
    <button class="btn" id="apply">Apply</button>
    <button class="btn ghost" id="close">Close</button>
  </div>
</div>  

<script type="module">
  import { loadBooks, resolve } from './js/resolver.js';
  import { makeEngine } from './js/engine.js';

  const canvas = document.getElementById('stage');
  const engine = makeEngine(canvas);

  const sheet = document.getElementById('sheet');
  const box   = document.getElementById('seedBox');
  const hint  = document.getElementById('hint');

  function openSheet(){ sheet.classList.add('open'); box.focus(); setTimeout(()=>box.select(),0); }
  function closeSheet(){ sheet.classList.remove('open'); }

  // tap anywhere to open
  addEventListener('click', (e)=>{ if(!sheet.contains(e.target)) openSheet(); });
  document.getElementById('apply').onclick = applySeed;
  document.getElementById('close').onclick = ()=> closeSheet();

  async function applySeed(){
    const text = (box.value || '').trim();
    if(!text) return;
    const state = await resolve(text);
    // params
    engine.applyParams(state.params);
    // meta
    for(const m of state.metaEvents) engine.applyMeta(m);
    // masks / laws / silences (no-ops until you wire deeper)
    for(const s of state.silences) engine.applySilence?.(s);
    for(const k of state.masks) engine.applyMask?.(k);
    engine.kick();
    hint.style.display='none';
    closeSheet();
  }

  // boot
  await loadBooks();
  // auto-paste if clipboard has text (best effort; user gesture required on some browsers)
  try {
    const t = await navigator.clipboard.readText();
    if(t && t.trim().length){
      box.value = t.trim();
      await applySeed();
    }
  } catch(_) {}

  // URL ?seed= support
  const q = new URLSearchParams(location.search);
  if(q.has('seed')){ box.value = q.get('seed'); await applySeed(); }

  // first frame
  engine.kick();


  <!-- Scripts at the bottom so DOM is ready before execution -->
  <script src="./js/resolver.js"></script>
  <script src="./js/spellbook-resolver.js"></script>
  <script src="./js/engine.js"></script>
</body>
</html>
